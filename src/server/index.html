<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antfarm Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono&display=swap" rel="stylesheet">
<style>
@font-face{font-family:'Geist Pixel';src:url('/fonts/GeistPixel-Square.woff2') format('woff2');font-display:swap}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Geist',sans-serif;background:#FAF8F5;color:#3A3226;min-height:100vh}
header{background:#6B7F3B;border-bottom:2px solid #5a6b32;padding:12px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
header img{height:36px;border-radius:6px}
header h1{font-family:'Geist',sans-serif;font-size:22px;font-weight:600;color:#fff;letter-spacing:0}
header h1 span{color:#D4E8A0}
select{background:#5a6b32;color:#fff;border:1px solid #4a5a28;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer}
select option{background:#5a6b32;color:#fff}
select:focus{outline:none;border-color:#8ECFC0}
.board{display:flex;gap:16px;padding:24px;overflow-x:auto;min-height:calc(100vh - 65px)}
.column{min-width:240px;flex:1;background:#fff;border:1px solid #D4C4A0;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 1px 3px rgba(58,50,38,.08)}
.column-header{padding:12px 16px;border-bottom:1px solid #D4C4A0;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#6B7F3B;background:#f5f0e8}
.column-header .count{background:#6B7F3B;color:#fff;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:8px}
.cards{padding:8px;flex:1;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.card{background:#FAF8F5;border:1px solid #D4C4A0;border-radius:6px;padding:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.card:hover{border-color:#E8845C;box-shadow:0 2px 8px rgba(232,132,92,.15)}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(58,50,38,.5);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s}
.overlay.open{opacity:1;pointer-events:auto}
.panel{background:#fff;border:1px solid #D4C4A0;border-radius:12px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto;padding:24px;position:relative;box-shadow:0 8px 32px rgba(58,50,38,.15)}
.panel-close{position:absolute;top:12px;right:16px;background:none;border:none;color:#8b8072;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.panel-close:hover{color:#3A3226;background:#f5f0e8}
.panel h2{font-size:16px;font-weight:600;color:#3A3226;margin-bottom:4px;padding-right:40px}
.panel-task{font-size:13px;color:#8b8072;margin-bottom:16px;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow-y:auto;line-height:1.5}
.panel-meta{display:flex;gap:12px;margin-bottom:20px;font-size:12px;color:#8b8072;flex-wrap:wrap}
.panel-meta span{display:flex;align-items:center;gap:4px}
.steps-list{display:flex;flex-direction:column;gap:8px}
.step-row{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#FAF8F5;border:1px solid #D4C4A0;border-radius:6px}
.step-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.step-icon.done{background:#6B7F3B22;color:#6B7F3B}
.step-icon.running{background:#8ECFC033;color:#3a9e8a}
.step-icon.pending{background:#D4C4A044;color:#8b8072}
.step-icon.waiting{background:#D4C4A044;color:#8b8072}
.step-icon.failed,.step-icon.error{background:#E8845C22;color:#d4603a}
.step-name{font-size:13px;font-weight:500;color:#3A3226;flex:1}
.step-agent{font-size:11px;color:#8b8072;font-family:'Geist Mono',monospace}
.step-status{font-size:11px;text-transform:uppercase;font-weight:600}
.card-title{font-size:13px;font-weight:500;color:#3A3226;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-meta{font-size:11px;color:#8b8072;display:flex;justify-content:space-between;align-items:center}
.badge{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;text-transform:uppercase}
.badge-running{background:#8ECFC033;color:#3a9e8a}
.badge-done,.badge-completed{background:#6B7F3B22;color:#6B7F3B}
.badge-failed,.badge-error{background:#E8845C22;color:#d4603a}
.badge-waiting{background:#D4C4A044;color:#8b8072}
.badge-pending{background:#D4C4A044;color:#8b8072}
.badge-blocked{background:#E8845C11;color:#E8845C}
.card.done{border-left:3px solid #6B7F3B}
.card.failed,.card.error{border-left:3px solid #E8845C}
.empty{color:#8b8072;font-size:12px;text-align:center;padding:24px 8px}
.refresh-note{color:rgba(255,255,255,.6);font-size:11px;margin-left:auto}
@media(max-width:768px){.board{flex-direction:column}.column{min-width:unset}}
.story-open{display:block!important}
.story-chevron-open{transform:rotate(90deg)}
</style>
</head>
<body>
<header>
  <h1><span>antfarm</span> dashboard</h1>
  <select id="wf-select"><option value="">Loading...</option></select>
  <span class="refresh-note" id="refresh-note">Auto-refresh: 30s</span>
</header>
<div class="board" id="board"><div class="empty" style="margin:auto">Select a workflow</div></div>
<div class="overlay" id="overlay" onclick="if(event.target===this)closePanel()">
  <div class="panel" id="panel"></div>
</div>

<script>
const API = '';
let workflows = [];
let currentWf = null;

async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function loadWorkflows() {
  workflows = await fetchJSON('/api/workflows');
  const sel = document.getElementById('wf-select');
  sel.innerHTML = '<option value="">— select workflow —</option>' +
    workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  if (workflows.length === 1) {
    sel.value = workflows[0].id;
    selectWorkflow(workflows[0].id);
  }
}

function selectWorkflow(id) {
  currentWf = workflows.find(w => w.id === id) || null;
  if (currentWf) loadRuns();
  else document.getElementById('board').innerHTML = '<div class="empty" style="margin:auto">Select a workflow</div>';
}

async function loadRuns() {
  if (!currentWf) return;
  const runs = await fetchJSON(`/api/runs?workflow=${currentWf.id}`);
  renderBoard(currentWf, runs);
}

function getActiveStepId(run) {
  if (!run.steps || !run.steps.length) return null;
  const active = run.steps.find(s => s.status !== 'done' && s.status !== 'skipped');
  return active ? active.step_id : run.steps[run.steps.length - 1].step_id;
}

function renderBoard(wf, runs) {
  const board = document.getElementById('board');
  const columns = {};
  wf.steps.forEach(s => { columns[s.id] = []; });

  runs.forEach(run => {
    const stepId = getActiveStepId(run);
    const col = stepId && columns[stepId] !== undefined ? stepId : wf.steps[wf.steps.length - 1]?.id;
    if (col && columns[col]) columns[col].push(run);
  });

  board.innerHTML = wf.steps.map(step => {
    const cards = columns[step.id];
    const cardHTML = cards.length === 0
      ? '<div class="empty">No runs</div>'
      : cards.map(run => {
          const isDone = run.status === 'done';
          const isFailed = run.status === 'failed' || run.status === 'error';
          const cls = isDone ? 'done' : isFailed ? 'failed' : '';
          const badge = `badge-${run.status}`;
          const time = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
          const title = run.task.length > 60 ? run.task.slice(0, 57) + '…' : run.task;
          return `<div class="card ${cls}" onclick="openRun('${run.id}')">
            <div class="card-title" title="${run.task.replace(/"/g, '&quot;')}">${title}</div>
            <div class="card-meta">
              <span class="badge ${badge}">${run.status}</span>
              <span>${time}</span>
            </div>
          </div>`;
        }).join('');
    return `<div class="column">
      <div class="column-header">${step.id}<span class="count">${cards.length}</span></div>
      <div class="cards">${cardHTML}</div>
    </div>`;
  }).join('');
}

const stepIcons = {done:'✓',running:'●',pending:'○',waiting:'◌',failed:'✗',error:'✗'};
function esc(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function openRun(id) {
  const run = await fetchJSON(`/api/runs/${id}`);
  const panel = document.getElementById('panel');
  const created = run.created_at ? new Date(run.created_at).toLocaleString() : '';
  const updated = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
  const stepsHTML = (run.steps || []).map(s => {
    const st = s.status || 'waiting';
    const icon = stepIcons[st] || '○';
    return `<div class="step-row">
      <div class="step-icon ${st}">${icon}</div>
      <div class="step-name">${s.step_id}</div>
      <div class="step-agent">${s.agent_id || ''}</div>
      <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
    </div>`;
  }).join('');
  panel.innerHTML = `
    <button class="panel-close" onclick="closePanel()">✕</button>
    <h2>${run.workflow_id}</h2>
    <div class="panel-task">${esc(run.task)}</div>
    <div class="panel-meta">
      <span><span class="badge badge-${run.status}">${run.status}</span></span>
      <span>Created: ${created}</span>
      <span>Updated: ${updated}</span>
    </div>
    <div class="steps-list">${stepsHTML}</div>
    <div id="stories-panel"></div>
  `;
  document.getElementById('overlay').classList.add('open');
  loadStories(id);
}

function closePanel() {
  document.getElementById('overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

async function loadStories(runId) {
  const stories = await fetchJSON(`/api/runs/${runId}/stories`);
  const panel = document.getElementById('stories-panel');
  if (!stories || stories.length === 0) { panel.innerHTML = ''; return; }
  const done = stories.filter(s => s.status === 'done').length;
  const pct = Math.round((done / stories.length) * 100);
  panel.innerHTML = `
    <div style="margin-top:24px;border-top:1px solid #D4C4A0;padding-top:20px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-size:15px;font-weight:600;color:#3A3226">Stories</h3>
        <span style="font-size:13px;font-weight:600;color:#6B7F3B">${done} / ${stories.length} done</span>
      </div>
      <div style="background:#D4C4A044;border-radius:4px;height:8px;margin-bottom:16px;overflow:hidden">
        <div style="background:#6B7F3B;height:100%;width:${pct}%;border-radius:4px;transition:width .3s"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${stories.map((s, i) => {
          const st = s.status || 'pending';
          const icon = stepIcons[st] || '○';
          let ac = [];
          try { ac = JSON.parse(s.acceptance_criteria || '[]'); } catch { ac = [s.acceptance_criteria]; }
          const retryInfo = s.retry_count > 0 ? ` <span style="color:#E8845C;font-size:10px">(retry ${s.retry_count})</span>` : '';
          const hasDetails = s.description || ac.length > 0 || s.output;
          const toggleAttr = hasDetails ? `onclick="this.querySelector('.story-details').classList.toggle('story-open');this.querySelector('.story-chevron').classList.toggle('story-chevron-open')" style="cursor:pointer"` : '';
          return `<div class="step-row" style="flex-direction:column;align-items:stretch;gap:0;padding:0;overflow:hidden" ${toggleAttr}>
            <div style="display:flex;align-items:center;gap:8px;padding:10px 12px">
              <div class="step-icon ${st}">${icon}</div>
              <div class="step-name" style="flex:1">${s.story_id}: ${s.title}${retryInfo}</div>
              <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
              ${hasDetails ? '<span class="story-chevron" style="color:#8b8072;font-size:10px;transition:transform .15s;display:inline-block">▶</span>' : ''}
            </div>
            ${hasDetails ? `<div class="story-details" style="display:none;padding:0 12px 12px 44px;font-size:12px;color:#5a5045;line-height:1.6">
              ${s.description ? `<div style="margin-bottom:8px">${esc(s.description)}</div>` : ''}
              ${ac.length > 0 ? `<div style="margin-bottom:8px"><div style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.3px;color:#6B7F3B;margin-bottom:4px">Acceptance Criteria</div>${ac.map(c => `<label style="display:flex;align-items:flex-start;gap:6px;margin-bottom:3px;cursor:default"><span style="color:${st==='done'?'#6B7F3B':'#D4C4A0'};flex-shrink:0">${st==='done'?'☑':'☐'}</span><span>${esc(c)}</span></label>`).join('')}</div>` : ''}
              ${s.output ? `<details style="margin-top:4px" onclick="event.stopPropagation()"><summary style="font-size:11px;color:#8b8072;cursor:pointer;font-weight:500">Output</summary><pre style="margin-top:6px;padding:8px;background:#FAF8F5;border:1px solid #D4C4A0;border-radius:4px;font-family:'Geist Mono',monospace;font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto">${esc(s.output)}</pre></details>` : ''}
            </div>` : ''}
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
}

document.getElementById('wf-select').addEventListener('change', e => selectWorkflow(e.target.value));
loadWorkflows();
setInterval(() => { if (currentWf) loadRuns(); }, 30000);
</script>
</body>
</html>
